name: tagpr

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  tagpr:
    name: Create or update release PR / tag
    runs-on: ubuntu-latest
    outputs:
      tagpr-tag: ${{ steps.run-tagpr.outputs.tag }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install Python
        run: uv python install 3.13

      - name: Run tagpr
        id: run-tagpr
        uses: Songmu/tagpr@v1

  publish:
    name: Build and publish release
    needs: tagpr
    if: needs.tagpr.outputs.tagpr-tag != ''
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: write
      id-token: write
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up uv
        uses: astral-sh/setup-uv@v7

      - name: Install Python
        run: uv python install 3.13

      - name: Build distributions
        run: uv build

      - name: Upload release assets
        env:
          RELEASE_TAG: ${{ needs.tagpr.outputs.tagpr-tag }}
        run: gh release upload "$RELEASE_TAG" dist/* --clobber

      - name: Publish package distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

      - name: Publish GitHub Release
        env:
          RELEASE_TAG: ${{ needs.tagpr.outputs.tagpr-tag }}
          TARGET_REPOSITORY: ${{ github.repository }}
        run: |
          gh api \
            "/repos/$TARGET_REPOSITORY/releases/generate-notes" \
            -f "tag_name=$RELEASE_TAG" \
            --jq .body \
            | gh release edit "$RELEASE_TAG" --repo "$TARGET_REPOSITORY" --draft=false --latest --notes-file=-
